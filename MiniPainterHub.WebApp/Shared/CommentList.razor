@using MiniPainterHub.Common.DTOs
@using MiniPainterHub.WebApp.Services
@using System.Net
@inject ICommentService CommentService

<div>
    @if (!string.IsNullOrEmpty(_loadError))
    {
        <div class="alert alert-warning d-flex align-items-center" role="alert">
            <i class="bi bi-exclamation-triangle-fill me-2"></i>
            <div>
                @_loadError
                @if (_errorStatus.HasValue)
                {
                    <span class="text-muted small">(Status: @((int)_errorStatus.Value))</span>
                }
            </div>
            <button class="btn btn-link btn-sm ms-auto" @onclick="ReloadAsync">Retry</button>
        </div>
    }
    else if (_comments == null)
    {
        <p class="text-muted"><em>Loading comments…</em></p>
    }
    else if (_comments.Items.Count() == 0)
    {
        <p class="text-muted"><em>No comments yet.</em></p>
    }
    else
    {
        @foreach (var c in _comments.Items)
        {
            <CommentItem Comment="c" />
        }

        <nav aria-label="Comment pagination">
            <ul class="pagination">
                <li class="page-item @( _page == 1 ? "disabled" : "" )">
                    <button class="page-link" @onclick="() => ChangePage(_page - 1)">«</button>
                </li>
                @for (int i = 1; i <= _comments.TotalPages; i++)
                {
                    
                    int referenceToPageNumber = i;
                    
                    <li class="page-item @( i == _page ? "active" : "" )">

                        <button class="page-link" @onclick="() => ChangePage(referenceToPageNumber)">@i</button>
                    </li>
                }
                <li class="page-item @( _page == _comments.TotalPages ? "disabled" : "" )">
                    <button class="page-link" @onclick="() => ChangePage(_page + 1)">»</button>
                </li>
            </ul>
        </nav>
    }
</div>

@code {
    [Parameter] public int PostId { get; set; }

    private PagedResult<CommentDto>? _comments;
    private int _page = 1;
    private const int PageSize = 10;
    private string? _loadError;
    private HttpStatusCode? _errorStatus;

    protected override async Task OnParametersSetAsync()
        => await LoadPageAsync();

    public async Task ReloadAsync()
    {
        Console.WriteLine($"ReloadAsync called at {DateTime.Now:hh:mm:ss}");
        await LoadPageAsync();
    }

    private async Task LoadPageAsync()
    {
        Console.WriteLine($"LoadPageAsync hit for PostId={PostId} at {DateTime.Now:hh:mm:ss}");

        _loadError = null;
        _errorStatus = null;

        var response = await CommentService.GetByPostAsync(PostId, _page, PageSize);

        if (!response.Success)
        {
            _errorStatus = response.StatusCode;
            _loadError = response.StatusCode == HttpStatusCode.NotFound
                ? "Comments could not be found for this post."
                : "We couldn't load comments right now. Please try again.";
            _comments = null;
        }
        else
        {
            _comments = response.Value ?? new PagedResult<CommentDto>();
        }

        await InvokeAsync(StateHasChanged);
    }

    private async Task ChangePage(int newPage)
    {
        if (newPage < 1 || newPage > (_comments?.TotalPages ?? 1))
            return;

        _page = newPage;
        await LoadPageAsync();
        StateHasChanged();
    }
}
