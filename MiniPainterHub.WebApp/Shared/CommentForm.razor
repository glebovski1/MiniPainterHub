@using System.Net
@using MiniPainterHub.Common.DTOs
@using MiniPainterHub.WebApp.Services
@inject ICommentService CommentService

@if (!string.IsNullOrEmpty(_submitError))
{
    <div class="alert alert-warning d-flex align-items-center" role="alert">
        <i class="bi bi-exclamation-triangle-fill me-2"></i>
        <div>
            @_submitError
            @if (_submitStatus.HasValue)
            {
                <span class="text-muted small">(Status: @((int)_submitStatus.Value))</span>
            }
        </div>
    </div>
}

<EditForm Model="_model" OnValidSubmit="HandleSubmit">
    <DataAnnotationsValidator />
    <ValidationSummary />

    <InputTextArea @bind-Value="_model.Text"
                   class="form-control"
                   placeholder="Write your comment…"
                   rows="3" />

    <button type="submit"
            class="btn btn-primary mt-2"
            disabled="@_isSubmitting">
        @(_isSubmitting ? "Posting…" : "Post Comment")
    </button>
</EditForm>

@code {
    [Parameter]
    public int PostId { get; set; }

    [Parameter]
    public EventCallback OnCommentAdded { get; set; }

    private CreateCommentDto _model = new();
    private bool _isSubmitting;
    private string? _submitError;
    private HttpStatusCode? _submitStatus;

    private async Task HandleSubmit()
    {
        _submitError = null;
        _submitStatus = null;
        _isSubmitting = true;

        var response = await CommentService.CreateAsync(PostId, _model);

        if (response.Success && response.Value is not null)
        {
            _model.Text = string.Empty;

            if (OnCommentAdded.HasDelegate)
            {
                await OnCommentAdded.InvokeAsync();
            }
        }
        else
        {
            _submitStatus = response.StatusCode;
            _submitError = response.StatusCode == HttpStatusCode.Unauthorized
                ? "Please sign in to add a comment."
                : "We couldn't post your comment. Please try again.";
        }

        _isSubmitting = false;
    }
}
