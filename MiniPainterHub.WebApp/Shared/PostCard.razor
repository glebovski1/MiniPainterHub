@using MiniPainterHub.Common.DTOs
@inject NavigationManager Navigation

<div class="card h-100 shadow-sm">
    <NavLink class="text-decoration-none text-dark" href="@($"/posts/{Post.Id}")">
        @if (!string.IsNullOrEmpty(Post.ImageUrl))
        {
            <img src="@ThumbImageUrl"
                 class="card-img-top bg-light"
                 alt="Post image"
                 loading="lazy"
                 style="height: 180px; object-fit: contain;" />
        }
        <div class="card-body">
            <h5 class="card-title">@Post.Title</h5>
            <p class="card-text text-truncate">@Post.Snippet</p>
        </div>
    </NavLink>
    <div class="card-footer d-flex justify-content-between align-items-center mt-auto">
        <small class="text-muted">
            @Post.AuthorName • @Post.CreatedAt.ToLocalTime().ToString("MMM dd, yyyy")
        </small>
        <div>
            <span class="me-2"><i class="bi bi-chat-left-text"></i> @Post.CommentCount</span>
            <span><i class="bi bi-heart"></i> @Post.LikeCount</span>
        </div>
    </div>
</div>

@code {
    [Parameter] public PostSummaryDto Post { get; set; } = default!;

    private string FullImageUrl => MakeAbsoluteUrl(Post.ImageUrl);

    private string ThumbImageUrl => MakeAbsoluteUrl(ReplaceVariantSuffix(Post.ImageUrl, "_thumb."));

    private string MakeAbsoluteUrl(string? url)
        => string.IsNullOrEmpty(url)
            ? string.Empty
            : url.StartsWith("http", StringComparison.OrdinalIgnoreCase)
                ? url
                : $"{Navigation.BaseUri.TrimEnd('/')}{url}";

    private static string ReplaceVariantSuffix(string? url, string replacement)
    {
        if (string.IsNullOrEmpty(url))
        {
            return string.Empty;
        }

        return url.Contains("_max.", StringComparison.OrdinalIgnoreCase)
            ? url.Replace("_max.", replacement, StringComparison.OrdinalIgnoreCase)
            : url;
    }
}
