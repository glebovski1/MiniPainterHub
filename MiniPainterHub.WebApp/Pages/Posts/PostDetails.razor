@page "/posts/{PostId:int}"
@using MiniPainterHub.Common.DTOs
@inject IPostService PostService
@inject NavigationManager Nav
@using MiniPainterHub.WebApp.Shared
@using System.Linq

<div class="container mt-4" style="max-width: 768px;">
    @if (isLoading)
    {
        <div class="d-flex justify-content-center align-items-center" style="min-height: 200px;">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    }
    else if (post is null)
    {
        <div class="alert alert-warning text-center">
            <strong>Oops!</strong> Post not found.
        </div>
    }
    else
    {
        <div class="card shadow-lg p-4">

            @* 🔳 Image/Gallery Section *@
            @if (HasImages)
            {
                <div class="bg-light border rounded p-3 mb-4">
                    <div class="text-center mb-2">
                        <img src="@SelectedImageUrl"
                             class="img-fluid rounded shadow-sm"
                             alt="Post image"
                             loading="lazy"
                             style="cursor: zoom-in;"
                             @onclick="ShowZoomModal" />
                    </div>
                    <div class="d-flex flex-wrap gap-2 justify-content-center">
                        @for (int i = 0; i < PostImages!.Count; i++)
                        {
                            var img = PostImages[i];
                            <img src="@GetThumbnailUrl(img)"
                                 class="img-thumbnail"
                                 style="width:80px;height:80px;object-fit:cover;cursor:pointer;"
                                 @onclick="@(() => SelectImage(i))" />
                        }
                    </div>
                </div>
            }
            else if (!string.IsNullOrEmpty(post.ImageUrl))
            {
                <div class="bg-light border rounded p-3 mb-4">
                    <div class="text-center">
                        <img src="@GetAbsoluteUrl(post.ImageUrl)"
                             class="img-fluid rounded shadow-sm"
                             alt="Post image"
                             loading="lazy"
                             style="cursor: zoom-in;"
                             @onclick="ShowZoomModal" />
                    </div>
                </div>
            }

            @* 📝 Post Content *@
            <div class="card-body p-0">
                <h2 class="card-title mb-3">@post.Title</h2>

                <p class="text-muted small mb-3">
                    <i class="bi bi-person me-1"></i>
                    <strong>@post.AuthorName</strong>
                    <span class="mx-2">•</span>
                    <i class="bi bi-calendar3 me-1"></i>
                    @post.CreatedAt.ToLocalTime().ToString("MMM dd, yyyy")
                </p>
                <div class="card-text mb-4">
                    @post.Content
                </div>
                That way:
                <div class="d-flex align-items-center gap-3 mb-4">
                    <LikeButton PostId="@PostId" />

                    <button class="btn btn-outline-secondary btn-sm ms-auto"
                            @onclick='() => Nav.NavigateTo("/")'>
                        ← Back
                    </button>
                </div>
                <h5 class="mb-3">
                    Comments
                </h5>
                <CommentForm PostId="@PostId" OnCommentAdded="ReloadComments" />
                <CommentList @ref="_commentList" PostId="@PostId" />
            </div>
        </div>
    }
</div>

@* 🔍 Zoom Modal *@
@if (showModal)
{
    <div class="modal fade show d-block" style="background: rgba(0,0,0,0.6);" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content bg-transparent border-0">
                <img src="@SelectedImageUrl" class="img-fluid rounded zoomed-image" alt="Zoomed image" />
                <button type="button" class="btn-close position-absolute top-0 end-0 m-3 bg-white rounded-circle"
                        aria-label="Close"
                        @onclick="CloseZoomModal"></button>
            </div>
        </div>
    </div>
}

@code {
    [Parameter] public int PostId { get; set; }
    private CommentList? _commentList;
    private PostDto? post;
    private bool isLoading;
    private bool showModal = false;
    private int selectedIndex = 0;
    private IReadOnlyList<dynamic>? PostImages => (post as dynamic)?.Images as IReadOnlyList<dynamic>;
    private bool HasImages => PostImages != null && PostImages.Count > 0;
    private string SelectedImageUrl => HasImages
        ? GetImageUrl(PostImages![selectedIndex])
        : GetAbsoluteUrl(post?.ImageUrl);

    protected override async Task OnInitializedAsync()
    {
        isLoading = true;
        try
        {
            post = await PostService.GetByIdAsync(PostId);
        }
        catch
        {
            post = null;
        }
        isLoading = false;
    }

    private async Task ReloadComments()
    {
        if (_commentList != null)
            await _commentList.ReloadAsync();
    }

    private void ShowZoomModal() => showModal = true;
    private void CloseZoomModal() => showModal = false;

    private void SelectImage(int index) => selectedIndex = index;

    private string GetImageUrl(dynamic img) => GetAbsoluteUrl((string?)(img?.Url ?? img?.url));

    private string GetThumbnailUrl(dynamic img) => GetAbsoluteUrl((string?)(img?.ThumbnailUrl ?? img?.thumbnailUrl ?? img?.Url ?? img?.url));

    private string GetAbsoluteUrl(string? url)
    {
        if (string.IsNullOrEmpty(url))
            return string.Empty;
        return url.StartsWith("http", StringComparison.OrdinalIgnoreCase)
            ? url
            : $"{Nav.BaseUri.TrimEnd('/')}{url}";
    }
}
