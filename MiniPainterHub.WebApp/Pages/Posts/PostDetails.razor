@page "/posts/{PostId:int}"
@using MiniPainterHub.Common.DTOs
@inject ApiClient Api
@inject NavigationManager Nav
@using MiniPainterHub.WebApp.Services.Http
@using System.Net.Http
@using MiniPainterHub.WebApp.Shared
@using System.Linq
@using System.Collections.Generic

<div class="container mt-4" style="max-width: 768px;">
    @if (isLoading)
    {
        <div class="d-flex justify-content-center align-items-center" style="min-height: 200px;">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    }
    else if (post is null)
    {
        <div class="alert alert-warning text-center">
            <strong>Oops!</strong> Post not found.
        </div>
    }
    else
    {
        <div class="card shadow-lg p-4">

            @* üî≥ Image/Gallery Section *@
            @if (HasImages)
            {
                <div class="bg-light border rounded p-3 mb-4">
                    <div class="text-center mb-2">
                        <img src="@SelectedImageUrl"
                             class="img-fluid rounded shadow-sm"
                             alt="Post image"
                             loading="lazy"
                             style="cursor: zoom-in;"
                             @onclick="ShowZoomModal" />
                    </div>
                    <div class="d-flex flex-wrap gap-2 justify-content-center">
                        @for (int i = 0; i < PostImages!.Count; i++)
                        {
                            int imageIndex = i;
                            var img = PostImages[i];
                            <img src="@GetThumbnailUrl(img)"
                                 class="img-thumbnail"
                                 style="width:80px;height:80px;object-fit:cover;cursor:pointer;"
                                 @onclick="@(() => SelectImage(imageIndex))" />
                        }
                    </div>
                </div>
            }
            else if (!string.IsNullOrEmpty(post.ImageUrl))
            {
                <div class="bg-light border rounded p-3 mb-4">
                    <div class="text-center">
                        <img src="@GetAbsoluteUrl(post.ImageUrl)"
                             class="img-fluid rounded shadow-sm"
                             alt="Post image"
                             loading="lazy"
                             style="cursor: zoom-in;"
                             @onclick="ShowZoomModal" />
                    </div>
                </div>
            }

            @* üìù Post Content *@
            <div class="card-body p-0">
                <h2 class="card-title mb-3">@post.Title</h2>

                <p class="text-muted small mb-3">
                    <i class="bi bi-person me-1"></i>
                    <strong>@post.AuthorName</strong>
                    <span class="mx-2">‚Ä¢</span>
                    <i class="bi bi-calendar3 me-1"></i>
                    @post.CreatedAt.ToLocalTime().ToString("MMM dd, yyyy")
                </p>

                <div class="card-text mb-4">
                    @post.Content
                </div>

                <div class="d-flex align-items-center gap-3 mb-4">
                    <LikeButton PostId="@PostId" />

                    <button class="btn btn-outline-secondary btn-sm ms-auto"
                            @onclick='() => Nav.NavigateTo("/")'>
                        ‚Üê Back
                    </button>
                </div>

                <h5 class="mb-3">Comments</h5>
                <CommentForm PostId="@PostId" OnCommentAdded="ReloadComments" />
                <CommentList @ref="_commentList" PostId="@PostId" />
            </div>
        </div>
    }
</div>

@* üîç Zoom Modal *@
@if (showModal)
{
    <div class="modal fade show d-block" style="background: rgba(0,0,0,0.6);" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content bg-transparent border-0">
                <img src="@SelectedImageUrl" class="img-fluid rounded zoomed-image" alt="Zoomed image" />
                <button type="button" class="btn-close position-absolute top-0 end-0 m-3 bg-white rounded-circle"
                        aria-label="Close"
                        @onclick="CloseZoomModal"></button>
            </div>
        </div>
    </div>
}

@code {
    [Parameter] public int PostId { get; set; }
    private CommentList? _commentList;
    private PostDto? post;
    private bool isLoading;
    private bool showModal = false;

    private int selectedIndex = 0;

    // Treat Images flexibly: supports List<PostImageDto>, arrays, etc., via dynamic
    private List<dynamic>? PostImages
        => TryGetImages(post);

    private bool HasImages => PostImages != null && PostImages.Count > 0;

    private string SelectedImageUrl
        => HasImages ? GetImageUrl(PostImages![selectedIndex])
                     : GetAbsoluteUrl(post?.ImageUrl);

    protected override async Task OnInitializedAsync()
    {
        isLoading = true;
        var request = new HttpRequestMessage(HttpMethod.Get, $"api/posts/{PostId}");
        post = await Api.SendAsync<PostDto>(request, new ApiRequestOptions { SuppressErrorNotifications = true });
        isLoading = false;
    }

    private async Task ReloadComments()
    {
        if (_commentList != null)
            await _commentList.ReloadAsync();
    }

    private void ShowZoomModal() => showModal = true;
    private void CloseZoomModal() => showModal = false;

    private void SelectImage(int index)
    {
        if (!HasImages) return;
        if (index < 0 || index >= PostImages!.Count) return;
        selectedIndex = index;
    }

    private static List<dynamic>? TryGetImages(PostDto? p)
    {
        if (p is null) return null;

        try
        {
            dynamic dyn = p;
            var imgs = dyn.Images;

            if (imgs is null) return null;

            // Normalize to List<dynamic>
            if (imgs is IEnumerable<object> seq)
                return seq.Select(x => (dynamic)x).ToList();

            return null;
        }
        catch
        {
            return null;
        }
    }

    private string GetImageUrl(dynamic img)
    {
        var url =
            TryGetString(img, nameof(PostImageDto.ImageUrl)) ??
            TryGetString(img, "Url") ??
            TryGetString(img, "imageUrl") ??
            TryGetString(img, "url");

        return GetAbsoluteUrl(url);
    }

    private string GetThumbnailUrl(dynamic img)
    {
        var thumb =
            TryGetString(img, nameof(PostImageDto.ThumbnailUrl)) ??
            TryGetString(img, "thumbnailUrl") ??
            TryGetString(img, nameof(PostImageDto.ImageUrl)) ??
            TryGetString(img, "Url") ??
            TryGetString(img, "imageUrl") ??
            TryGetString(img, "url");

        return GetAbsoluteUrl(thumb);
    }

    private static string? TryGetString(dynamic obj, string property)
    {
        if (obj is null) return null;

        // Attempt reflection on the object
        try
        {
            var prop = obj.GetType().GetProperty(property);
            if (prop != null)
            {
                var propValue = prop.GetValue(obj) as string;
                if (!string.IsNullOrWhiteSpace(propValue))
                    return propValue;
            }
        }
        catch { }

        // If the object behaves like a dictionary
        if (obj is IDictionary<string, object> dict &&
            dict.TryGetValue(property, out var value) &&
            value is string val && !string.IsNullOrWhiteSpace(val))
        {
            return val;
        }

        return null;
    }

    private string GetAbsoluteUrl(string? url)
    {
        if (string.IsNullOrEmpty(url))
            return string.Empty;

        return url.StartsWith("http", StringComparison.OrdinalIgnoreCase)
            ? url
            : $"{Nav.BaseUri.TrimEnd('/')}{url}";
    }
}

