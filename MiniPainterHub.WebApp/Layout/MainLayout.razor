@inherits LayoutComponentBase
@inject IJSRuntime JS
@using Microsoft.AspNetCore.Components.Authorization

<div class="app-layout">
    <header @ref="HeaderRef" id="appHeader" class="sticky-top bg-white">
        <NavMenu />
        </header>


    <!-- Slim header row; won’t disturb your NavMenu -->
    <div @ref="ToolBarRef" class="d-flex align-items-center justify-content-start gap-3 px-3 py-2 border-bottom bg-light">
        <AuthorizeView>
            <Authorized>
                <div class="form-check form-switch m-0">
                    <input class="form-check-input"
                           type="checkbox"
                           role="switch"
                           id="userPanelToggle"
                           checked="@IsPanelVisible"
                           @onchange="OnToggleChanged"
                           aria-label="Toggle personal panel" />
                    <label class="form-check-label d-none d-sm-inline" for="userPanelToggle">
                        Show personal panel
                    </label>
                </div>
            </Authorized>
        </AuthorizeView>
    </div>
    <UserPanelOverlay IsVisible="@IsPanelVisible"
                      OffsetTop="TopOffsetOfLeftPanel"
                      OnVisibilityChanged="HandlePanelVisibilityChanged" />
    <main class="container py-4">
        @Body

    </main>

</div>

@code {
    bool IsPanelVisible = false;

    private int TopOffsetOfLeftPanel = 0;

    private ElementReference HeaderRef;

    private ElementReference ToolBarRef;


    private void OnToggleChanged(ChangeEventArgs args)
    {
        IsPanelVisible = args.Value is bool checkedValue && checkedValue;
    }

    private Task HandlePanelVisibilityChanged(bool isVisible)
    {
        if (IsPanelVisible != isVisible)
        {
            IsPanelVisible = isVisible;
            StateHasChanged();
        }

        return Task.CompletedTask;
    }

    // Fix for CS0115: Use correct signature for OnAfterRenderAsync
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        int totalHeight = 0;
        if (firstRender)
        {
            totalHeight += await GetElementHeight(HeaderRef);
            totalHeight += await GetElementHeight(ToolBarRef);
            TopOffsetOfLeftPanel = totalHeight;
            StateHasChanged(); // Notify the component to re-render with the updated height
        }

    }

    private Task<int> GetElementHeight(ElementReference elementRef) =>
        JS.InvokeAsync<int>("domHelpers.getHeight", elementRef).AsTask();
}
